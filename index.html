<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="/src/styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tauri App</title>
    <script type="module" src="/src/main.ts" defer></script>

    <!-- Optional: helps avoid flash of default colors before JS runs -->
    <style>
      :root {
        --app-bg: #003865;
        --app-text: #ffffff;
      }
    </style>
  </head>

  <body>
    <div id="dragbar" data-tauri-drag-region></div>

    <!-- Theme controls (Background + Text) -->
    <div class="theme-panel" aria-label="Theme controls">
      <label class="theme-label">
        Background
        <select id="bgSelect" class="theme-select"></select>
      </label>

      <label class="theme-label">
        Text
        <select id="textSelect" class="theme-select"></select>
      </label>

      <div class="theme-meta" aria-live="polite">
        <span class="theme-pill"><span class="theme-dot bg"></span><span id="bgValue">BG</span></span>
        <span class="theme-pill"><span class="theme-dot"></span><span id="textValue">Text</span></span>
        <span class="theme-pill">Contrast <strong id="contrastValue">0.00:1</strong></span>
        <span id="aaNormal" class="theme-status">AA normal</span>
        <span id="aaLarge" class="theme-status">AA large</span>
        <button id="swapBtn" class="theme-btn" type="button" title="Swap background and text">Swap</button>
      </div>
    </div>

    <div class="wrap">
      <div class="message">
        <div id="msg-primary" contenteditable="true" spellcheck="false">Vilma</div>
        <div id="msg-secondary" contenteditable="true" spellcheck="false">CHECK YOUR ZOOM CHAT</div>
      </div>
    </div>

    <script>
      // Palette tokens: label + the CSS variable you already defined in styles.css
      const PCC = {
        "turquose":       { label: "Turquoise",      cssVar: "--pcc-turquose" },
        "navy":           { label: "Navy",           cssVar: "--pcc-navy" },
        "purple":         { label: "Purple",         cssVar: "--pcc-purple" },
        "apple-green":    { label: "Apple Green",    cssVar: "--pcc-apple-green" },
        "seafoam-green":  { label: "Seafoam Green",  cssVar: "--pcc-seafoam-green" },
        "tan":            { label: "Tan",            cssVar: "--pcc-tan" },
        "light-tan":      { label: "Light Tan",      cssVar: "--pcc-light-tan" },
        "salmon-pink":    { label: "Salmon Pink",    cssVar: "--pcc-salmon-pink" },
        "golden-yellow":  { label: "Golden Yellow",  cssVar: "--pcc-golden-yellow" },
        "bright-yellow":  { label: "Bright Yellow",  cssVar: "--pcc-bright-yellow" },
      };

      // Replace these with your accessibility-chart-approved lists when ready
      const BG_ALLOWED = Object.keys(PCC);
      const TEXT_ALLOWED = Object.keys(PCC);

      const root = document.documentElement;

      const bgSelect = document.getElementById("bgSelect");
      const textSelect = document.getElementById("textSelect");
      const bgValue = document.getElementById("bgValue");
      const textValue = document.getElementById("textValue");
      const contrastValue = document.getElementById("contrastValue");
      const aaNormal = document.getElementById("aaNormal");
      const aaLarge = document.getElementById("aaLarge");
      const swapBtn = document.getElementById("swapBtn");

      function fillSelect(select, allowedKeys) {
        select.innerHTML = "";
        for (const key of allowedKeys) {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = PCC[key].label;
          select.appendChild(opt);
        }
      }

      function setThemeSlot(slotVar, tokenKey) {
        const paletteVar = PCC[tokenKey].cssVar;
        root.style.setProperty(slotVar, `var(${paletteVar})`);
      }

      // ---- Contrast math (WCAG) ----
      function hexToRgb(hex) {
        const m = String(hex).trim().match(/^#([0-9a-f]{6})$/i);
        if (!m) return null;
        const n = parseInt(m[1], 16);
        return { r: (n >> 16) & 255, g: (n >> 8) & 255, b: n & 255 };
      }

      function srgbToLinear(v) {
        const s = v / 255;
        return s <= 0.04045 ? (s / 12.92) : Math.pow((s + 0.055) / 1.055, 2.4);
      }

      function relativeLuminance({ r, g, b }) {
        const R = srgbToLinear(r);
        const G = srgbToLinear(g);
        const B = srgbToLinear(b);
        return 0.2126 * R + 0.7152 * G + 0.0722 * B;
      }

      function contrastRatio(hex1, hex2) {
        const c1 = hexToRgb(hex1);
        const c2 = hexToRgb(hex2);
        if (!c1 || !c2) return null;
        const L1 = relativeLuminance(c1);
        const L2 = relativeLuminance(c2);
        const lighter = Math.max(L1, L2);
        const darker = Math.min(L1, L2);
        return (lighter + 0.05) / (darker + 0.05);
      }

      function getResolvedSlotHex(slotVarName) {
        const raw = getComputedStyle(root).getPropertyValue(slotVarName).trim();
        const varMatch = raw.match(/^var\((--[^)]+)\)$/);
        if (varMatch) {
          const paletteVar = varMatch[1];
          return getComputedStyle(root).getPropertyValue(paletteVar).trim();
        }
        return raw;
      }

      function updateStatus(el, ok, label) {
        el.classList.remove("pass", "fail");
        el.classList.add(ok ? "pass" : "fail");
        el.textContent = label + ": " + (ok ? "PASS" : "FAIL");
      }

      function updateUi() {
        const bgHex = getResolvedSlotHex("--app-bg");
        const textHex = getResolvedSlotHex("--app-text");

        bgValue.textContent = bgHex.toUpperCase();
        textValue.textContent = textHex.toUpperCase();

        const ratio = contrastRatio(bgHex, textHex);
        contrastValue.textContent = ratio ? `${ratio.toFixed(2)}:1` : "N/A";

        updateStatus(aaNormal, ratio !== null && ratio >= 4.5, "AA normal");
        updateStatus(aaLarge, ratio !== null && ratio >= 3.0, "AA large");
      }

      // ---- Init ----
      fillSelect(bgSelect, BG_ALLOWED);
      fillSelect(textSelect, TEXT_ALLOWED);

      // Initial values (you can change these)
      bgSelect.value = "navy";
      textSelect.value = "light-tan";

      // Apply to theme slots (styles.css should use these vars)
      setThemeSlot("--app-bg", bgSelect.value);
      setThemeSlot("--app-text", textSelect.value);
      updateUi();

      bgSelect.addEventListener("change", () => {
        setThemeSlot("--app-bg", bgSelect.value);
        updateUi();
      });

      textSelect.addEventListener("change", () => {
        setThemeSlot("--app-text", textSelect.value);
        updateUi();
      });

      swapBtn.addEventListener("click", () => {
        const oldBg = bgSelect.value;
        bgSelect.value = textSelect.value;
        textSelect.value = oldBg;
        setThemeSlot("--app-bg", bgSelect.value);
        setThemeSlot("--app-text", textSelect.value);
        updateUi();
      });
    </script>
  </body>
</html>
